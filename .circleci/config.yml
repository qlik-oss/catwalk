version: 2.1
jobs:
  build:
    docker:
      - image: circleci/node:10

    working_directory: ~/catwalk

    steps:
      - checkout

      - restore_cache:
          key: npm-dependency-cache-{{ checksum "package-lock.json" }}

      - run:
          name: Install dependencies
          command:
            npm ci

      - run:
          name: Run ESLint
          command:
            npm run lint

      - run:
          name: Unit tests
          command:
            npm run test:unit

      - run:
          name: Component tests
          command: |
            npm run test:comp

      - save_cache:
          paths:
            - node_modules
          key: npm-dependency-cache-{{ checksum "package-lock.json" }}
  e2e:
    working_directory: ~/catwalk
    docker:
      - image: cypress/base:14.17.3
    steps:
      - attach_workspace:
          at: ~/catwalk
      - run:
          name: Install cypress binaries
          command: npx cypress install
      - run:
          name: Running e2e tests
          command: |
            npm run parcel:build
            npm run test:e2e:ci
      - store_artifacts:
          path: cypress/
  deploy:
    working_directory: ~/catwalk
    docker:
      - image: circleci/node:lts
    steps:
      - attach_workspace:
          at: ~/catwalk
      - run:
          name: Sync dist to S3 bucket
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ] && [ "${TARGET_USER}" != "" ]; then
              sudo apt-get -y -qq install awscli
              aws configure set preview.cloudfront true

              npm run build
              aws s3 sync dist/ s3://catwalk.core.qlik.com/ --delete
              aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths '/*'
            fi
workflows:
  build-deploy:
    jobs:
      - build
      - e2e:
          requires:
            - build
      - deploy:
          requires:
            - e2e
